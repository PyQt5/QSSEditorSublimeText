#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Created on 2022/05/26
@author: Irony
@site: https://pyqt.site https://github.com/PyQt5
@email: 892768447@qq.com
@file: Client.py
@description:
"""

import asyncio
import functools
import json
import logging
from threading import Thread
from time import sleep

import sublime
import websockets
from jsonrpcclient import request_json
from websockets.connection import CLOSED, CLOSING

from qsseditor.Utils import PLUGIN_NAME, get_setting

logger = logging.getLogger(PLUGIN_NAME)

Client = None


class QSSEditorClient(Thread):

    def __init__(self, *args, **kwargs):
        super(QSSEditorClient, self).__init__(*args, **kwargs)
        logger.debug('QSSEditorClient::__init__')
        self.m_ws = None
        self.m_valid = True
        self.m_loop = asyncio.get_event_loop()

    def setValid(self, valid):
        self.m_valid = valid

    def applyStyle(self, view=None):
        if view is None:
            view = sublime.active_window().active_view()

        # 获取选中的内容
        styleSheets = [
            view.substr(sublime.Region(region.a, region.b))
            for region in view.sel()
            if not region.empty()
        ]
        styleSheets = [
            text for text in styleSheets if text.strip().strip('\r').strip('\n')
        ]

        if len(styleSheets) == 0:
            # 获取全部内容
            styleSheets.append(view.substr(sublime.Region(0, view.size())))

        if len(styleSheets) == 0:
            return

        asyncio.run_coroutine_threadsafe(self._applyStyle(styleSheets),
                                         self.m_loop)

    async def _applyStyle(self, style=[]):
        logger.debug('QSSEditorClient::applyStyle: {}'.format(str(style)))

    async def onHandler(self, method, params):
        if method == 'addKeywords':
            if not params or not isinstance(params, list):
                return
            print(method, params)

    async def _run(self):
        while self.m_valid:
            try:
                # 连接服务端
                self.m_ws = await websockets.connect('ws://127.0.0.1:{}'.format(
                    get_setting(None, 'server_port', 61052)))
                logger.info('connect successfully')
                # 接收消息
                while self.m_valid:
                    try:
                        response = json.loads(await self.m_ws.recv())
                        await self.onHandler(response.get('method', ''),
                                             response.get('params', []))
                    except Exception as e:
                        logger.error(str(e))
                        if self.m_ws.state in (CLOSING, CLOSED):
                            logger.info('connection is closed')
                            break
            except Exception as e:
                logger.error(str(e))
            await asyncio.sleep(3)

        logger.info('client is finished')

    def run(self):
        logger.info('client started')
        self.m_loop.run_until_complete(self._run())

    def stop(self):
        self.setValid(False)
        self.m_loop.stop()
        logger.info('client is stopped')
